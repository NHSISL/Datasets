/*
    Test: Column Completeness
    Run:  uv run run_tests.py --test test_column_completeness

    Checks NULL rates for columns across OLIDS tables.

    How it works:
      1. The 'checks' CTE has one row per column check. Each row counts
         total rows and NULL rows for that column in a single table scan.
      2. The 'threshold' value is the max allowed NULL % for that column.
         Primary keys use 0.0 (no NULLs allowed). Most columns use 1.0.
      3. The final SELECT computes the completeness % (100 - null%) and
         compares against the threshold. Empty tables return WARN.

    Output:
      - metric_value = completeness % (e.g. 99.5 means 0.5% NULLs)
      - threshold = minimum acceptable completeness %
      - total_rows, null_count = raw counts (shown with --verbose)

    To add a check:
      Add a UNION ALL SELECT row with (table_name, column_name, threshold, COUNT(*), SUM(...))
      Example:
        UNION ALL SELECT 'MY_TABLE', 'my_column', 1.0, COUNT(*),
            SUM(CASE WHEN my_column IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MY_TABLE
*/

WITH checks AS (
    -- Each row: table, column, max allowed NULL %, total rows, NULL count
    -- PATIENT (OLIDS_MASKED)
    SELECT 'PATIENT' AS table_name, 'id' AS column_name, 0.0 AS threshold, COUNT(*) AS total_rows, SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) AS null_count FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'sk_patient_id', 1.0, COUNT(*), SUM(CASE WHEN sk_patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'birth_year', 1.0, COUNT(*), SUM(CASE WHEN birth_year IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'birth_month', 1.0, COUNT(*), SUM(CASE WHEN birth_month IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'gender_concept_id', 1.0, COUNT(*), SUM(CASE WHEN gender_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT

    -- PATIENT_ADDRESS (OLIDS_MASKED)
    UNION ALL SELECT 'PATIENT_ADDRESS', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_ADDRESS
    UNION ALL SELECT 'PATIENT_ADDRESS', 'address_type_concept_id', 1.0, COUNT(*), SUM(CASE WHEN address_type_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_ADDRESS
    UNION ALL SELECT 'PATIENT_ADDRESS', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_ADDRESS

    -- PATIENT_CONTACT (OLIDS_MASKED)
    UNION ALL SELECT 'PATIENT_CONTACT', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_CONTACT
    UNION ALL SELECT 'PATIENT_CONTACT', 'contact_type_concept_id', 1.0, COUNT(*), SUM(CASE WHEN contact_type_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_CONTACT
    UNION ALL SELECT 'PATIENT_CONTACT', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_CONTACT

    -- PATIENT_UPRN (OLIDS_MASKED)
    UNION ALL SELECT 'PATIENT_UPRN', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_UPRN
    UNION ALL SELECT 'PATIENT_UPRN', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_MASKED.PATIENT_UPRN

    -- EPISODE_OF_CARE (OLIDS_COMMON)
    UNION ALL SELECT 'EPISODE_OF_CARE', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'patient_id', 1.0, COUNT(*), SUM(CASE WHEN patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'person_id', 1.0, COUNT(*), SUM(CASE WHEN person_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'episode_of_care_start_date', 1.0, COUNT(*), SUM(CASE WHEN episode_of_care_start_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'episode_type_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN episode_type_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'episode_status_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN episode_status_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.EPISODE_OF_CARE

    -- OBSERVATION (OLIDS_COMMON)
    UNION ALL SELECT 'OBSERVATION', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'patient_id', 1.0, COUNT(*), SUM(CASE WHEN patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'person_id', 1.0, COUNT(*), SUM(CASE WHEN person_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'observation_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN observation_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'result_value_units_concept_id', 1.0, COUNT(*), SUM(CASE WHEN result_value_units_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'episodicity_concept_id', 1.0, COUNT(*), SUM(CASE WHEN episodicity_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.OBSERVATION

    -- MEDICATION_STATEMENT (OLIDS_COMMON)
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'patient_id', 1.0, COUNT(*), SUM(CASE WHEN patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'person_id', 1.0, COUNT(*), SUM(CASE WHEN person_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'medication_statement_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN medication_statement_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'authorisation_type_concept_id', 1.0, COUNT(*), SUM(CASE WHEN authorisation_type_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_STATEMENT

    -- MEDICATION_ORDER (OLIDS_COMMON)
    UNION ALL SELECT 'MEDICATION_ORDER', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'patient_id', 1.0, COUNT(*), SUM(CASE WHEN patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'person_id', 1.0, COUNT(*), SUM(CASE WHEN person_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'medication_order_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN medication_order_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.MEDICATION_ORDER

    -- DIAGNOSTIC_ORDER (OLIDS_COMMON)
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'patient_id', 1.0, COUNT(*), SUM(CASE WHEN patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'person_id', 1.0, COUNT(*), SUM(CASE WHEN person_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'diagnostic_order_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN diagnostic_order_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'result_value_units_concept_id', 1.0, COUNT(*), SUM(CASE WHEN result_value_units_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'episodicity_concept_id', 1.0, COUNT(*), SUM(CASE WHEN episodicity_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER

    -- ENCOUNTER (OLIDS_COMMON)
    UNION ALL SELECT 'ENCOUNTER', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'patient_id', 1.0, COUNT(*), SUM(CASE WHEN patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'person_id', 1.0, COUNT(*), SUM(CASE WHEN person_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'encounter_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN encounter_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ENCOUNTER

    -- ALLERGY_INTOLERANCE (OLIDS_COMMON)
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'patient_id', 1.0, COUNT(*), SUM(CASE WHEN patient_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'person_id', 1.0, COUNT(*), SUM(CASE WHEN person_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'allergy_intolerance_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN allergy_intolerance_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE

    -- PROCEDURE_REQUEST (OLIDS_COMMON)
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'procedure_request_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN procedure_request_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'status_concept_id', 1.0, COUNT(*), SUM(CASE WHEN status_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PROCEDURE_REQUEST

    -- REFERRAL_REQUEST (OLIDS_COMMON)
    UNION ALL SELECT 'REFERRAL_REQUEST', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'clinical_effective_date', 1.0, COUNT(*), SUM(CASE WHEN clinical_effective_date IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'referral_request_source_concept_id', 1.0, COUNT(*), SUM(CASE WHEN referral_request_source_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'date_precision_concept_id', 1.0, COUNT(*), SUM(CASE WHEN date_precision_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'referral_request_priority_concept_id', 1.0, COUNT(*), SUM(CASE WHEN referral_request_priority_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'referral_request_type_concept_id', 1.0, COUNT(*), SUM(CASE WHEN referral_request_type_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'referral_request_specialty_concept_id', 1.0, COUNT(*), SUM(CASE WHEN referral_request_specialty_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.REFERRAL_REQUEST

    -- LOCATION_CONTACT (OLIDS_COMMON)
    UNION ALL SELECT 'LOCATION_CONTACT', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.LOCATION_CONTACT
    UNION ALL SELECT 'LOCATION_CONTACT', 'contact_type_concept_id', 1.0, COUNT(*), SUM(CASE WHEN contact_type_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.LOCATION_CONTACT
    UNION ALL SELECT 'LOCATION_CONTACT', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.LOCATION_CONTACT

    -- APPOINTMENT (OLIDS_COMMON)
    UNION ALL SELECT 'APPOINTMENT', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.APPOINTMENT
    UNION ALL SELECT 'APPOINTMENT', 'appointment_status_concept_id', 1.0, COUNT(*), SUM(CASE WHEN appointment_status_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.APPOINTMENT
    UNION ALL SELECT 'APPOINTMENT', 'booking_method_concept_id', 1.0, COUNT(*), SUM(CASE WHEN booking_method_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.APPOINTMENT
    UNION ALL SELECT 'APPOINTMENT', 'contact_mode_concept_id', 1.0, COUNT(*), SUM(CASE WHEN contact_mode_concept_id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.APPOINTMENT
    UNION ALL SELECT 'APPOINTMENT', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.APPOINTMENT

    -- APPOINTMENT_PRACTITIONER (OLIDS_COMMON)
    UNION ALL SELECT 'APPOINTMENT_PRACTITIONER', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.APPOINTMENT_PRACTITIONER
    UNION ALL SELECT 'APPOINTMENT_PRACTITIONER', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.APPOINTMENT_PRACTITIONER

    -- PATIENT_REGISTERED_PRACTITIONER_IN_ROLE (OLIDS_COMMON)
    UNION ALL SELECT 'PATIENT_REGISTERED_PRACTITIONER_IN_ROLE', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PATIENT_REGISTERED_PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PATIENT_REGISTERED_PRACTITIONER_IN_ROLE', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PATIENT_REGISTERED_PRACTITIONER_IN_ROLE

    -- LOCATION (OLIDS_COMMON)
    UNION ALL SELECT 'LOCATION', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.LOCATION
    UNION ALL SELECT 'LOCATION', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.LOCATION

    -- FLAG (OLIDS_COMMON)
    UNION ALL SELECT 'FLAG', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.FLAG
    UNION ALL SELECT 'FLAG', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.FLAG

    -- ORGANISATION (OLIDS_COMMON)
    UNION ALL SELECT 'ORGANISATION', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ORGANISATION
    UNION ALL SELECT 'ORGANISATION', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.ORGANISATION

    -- PRACTITIONER (OLIDS_COMMON)
    UNION ALL SELECT 'PRACTITIONER', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PRACTITIONER
    UNION ALL SELECT 'PRACTITIONER', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PRACTITIONER

    -- PRACTITIONER_IN_ROLE (OLIDS_COMMON)
    UNION ALL SELECT 'PRACTITIONER_IN_ROLE', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PRACTITIONER_IN_ROLE', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.PRACTITIONER_IN_ROLE

    -- SCHEDULE (OLIDS_COMMON)
    UNION ALL SELECT 'SCHEDULE', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.SCHEDULE
    UNION ALL SELECT 'SCHEDULE', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.SCHEDULE

    -- SCHEDULE_PRACTITIONER (OLIDS_COMMON)
    UNION ALL SELECT 'SCHEDULE_PRACTITIONER', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.SCHEDULE_PRACTITIONER
    UNION ALL SELECT 'SCHEDULE_PRACTITIONER', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_COMMON.SCHEDULE_PRACTITIONER

    -- CONCEPT (OLIDS_TERMINOLOGY)
    UNION ALL SELECT 'CONCEPT', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_TERMINOLOGY.CONCEPT
    UNION ALL SELECT 'CONCEPT', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_TERMINOLOGY.CONCEPT

    -- CONCEPT_MAP (OLIDS_TERMINOLOGY)
    UNION ALL SELECT 'CONCEPT_MAP', 'id', 0.0, COUNT(*), SUM(CASE WHEN id IS NULL THEN 1 ELSE 0 END) FROM OLIDS_TERMINOLOGY.CONCEPT_MAP
    UNION ALL SELECT 'CONCEPT_MAP', 'lds_start_date_time', 1.0, COUNT(*), SUM(CASE WHEN lds_start_date_time IS NULL THEN 1 ELSE 0 END) FROM OLIDS_TERMINOLOGY.CONCEPT_MAP
)

-- Compute completeness % and compare against threshold
SELECT
    'column_completeness' AS test_name,
    table_name,
    CASE WHEN total_rows = 0 THEN column_name || ' (empty table)' ELSE column_name END AS test_subject,
    CASE
        WHEN total_rows = 0 THEN 'WARN'
        WHEN ROUND(100.0 * null_count / total_rows, 4) <= threshold THEN 'PASS'
        ELSE 'FAIL'
    END AS status,
    CASE WHEN total_rows = 0 THEN NULL ELSE ROUND(100.0 - (100.0 * null_count / total_rows), 2) END AS metric_value,
    ROUND(100.0 - threshold, 2) AS threshold,
    total_rows,
    null_count
FROM checks
ORDER BY status DESC, null_count DESC, table_name, column_name;
