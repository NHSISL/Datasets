/*
    Test: Uniqueness
    Run:  uv run run_tests.py --test test_uniqueness

    Checks that key identifier columns contain no duplicate values.
    Duplicates in these columns cause fan-out in downstream joins
    and inflate row counts in derived datasets.

    How it works:
      1. The 'checks' CTE counts total rows and distinct non-NULL values
         for each column. Duplicates = total_rows - distinct_count.
      2. threshold = 100% (no duplicates allowed).
      3. Empty tables return WARN.

    Columns tested per table:
      - id: OLIDS record identifier
      - lds_record_id: LDS ingest record ID
      - lds_id: LDS entity ID
      - lds_business_key: LDS business key
    Note: CONCEPT and CONCEPT_MAP lack lds_record_id.

    Output:
      - metric_value = uniqueness % (100 means no duplicates)
      - total_rows, distinct_count, duplicate_count (shown with --verbose)
*/

SET schema_masked = 'OLIDS_MASKED';        -- Change if your ICB uses a different name (e.g. OLIDS_PCD)
SET schema_common = 'OLIDS_COMMON';
SET schema_terminology = 'OLIDS_TERMINOLOGY';

WITH checks AS (
    -- Each row: table, column, total rows, distinct non-NULL count
    -- PATIENT (OLIDS_MASKED)
    SELECT 'PATIENT' AS table_name, 'id' AS column_name, COUNT(*) AS total_rows, COUNT(DISTINCT id) AS distinct_count FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_MASKED.PATIENT
    UNION ALL SELECT 'PATIENT', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_MASKED.PATIENT

    -- PERSON (OLIDS_MASKED)
    UNION ALL SELECT 'PERSON', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_MASKED.PERSON
    UNION ALL SELECT 'PERSON', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_MASKED.PERSON
    UNION ALL SELECT 'PERSON', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_MASKED.PERSON
    UNION ALL SELECT 'PERSON', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_MASKED.PERSON

    -- PATIENT_ADDRESS (OLIDS_MASKED)
    UNION ALL SELECT 'PATIENT_ADDRESS', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_MASKED.PATIENT_ADDRESS
    UNION ALL SELECT 'PATIENT_ADDRESS', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_MASKED.PATIENT_ADDRESS
    UNION ALL SELECT 'PATIENT_ADDRESS', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_MASKED.PATIENT_ADDRESS
    UNION ALL SELECT 'PATIENT_ADDRESS', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_MASKED.PATIENT_ADDRESS

    -- PATIENT_CONTACT (OLIDS_MASKED)
    UNION ALL SELECT 'PATIENT_CONTACT', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_MASKED.PATIENT_CONTACT
    UNION ALL SELECT 'PATIENT_CONTACT', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_MASKED.PATIENT_CONTACT
    UNION ALL SELECT 'PATIENT_CONTACT', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_MASKED.PATIENT_CONTACT
    UNION ALL SELECT 'PATIENT_CONTACT', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_MASKED.PATIENT_CONTACT

    -- PATIENT_UPRN (OLIDS_MASKED)
    UNION ALL SELECT 'PATIENT_UPRN', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_MASKED.PATIENT_UPRN
    UNION ALL SELECT 'PATIENT_UPRN', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_MASKED.PATIENT_UPRN
    UNION ALL SELECT 'PATIENT_UPRN', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_MASKED.PATIENT_UPRN
    UNION ALL SELECT 'PATIENT_UPRN', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_MASKED.PATIENT_UPRN

    -- PATIENT_PERSON (OLIDS_COMMON)
    UNION ALL SELECT 'PATIENT_PERSON', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.PATIENT_PERSON
    UNION ALL SELECT 'PATIENT_PERSON', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.PATIENT_PERSON
    UNION ALL SELECT 'PATIENT_PERSON', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.PATIENT_PERSON
    UNION ALL SELECT 'PATIENT_PERSON', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.PATIENT_PERSON

    -- EPISODE_OF_CARE (OLIDS_COMMON)
    UNION ALL SELECT 'EPISODE_OF_CARE', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'lds_source_record_id', COUNT(*), COUNT(DISTINCT lds_source_record_id) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.EPISODE_OF_CARE
    UNION ALL SELECT 'EPISODE_OF_CARE', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.EPISODE_OF_CARE

    -- ENCOUNTER (OLIDS_COMMON)
    UNION ALL SELECT 'ENCOUNTER', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.ENCOUNTER
    UNION ALL SELECT 'ENCOUNTER', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.ENCOUNTER

    -- OBSERVATION (OLIDS_COMMON)
    UNION ALL SELECT 'OBSERVATION', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.OBSERVATION
    UNION ALL SELECT 'OBSERVATION', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.OBSERVATION

    -- MEDICATION_STATEMENT (OLIDS_COMMON)
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.MEDICATION_STATEMENT
    UNION ALL SELECT 'MEDICATION_STATEMENT', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.MEDICATION_STATEMENT

    -- MEDICATION_ORDER (OLIDS_COMMON)
    UNION ALL SELECT 'MEDICATION_ORDER', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.MEDICATION_ORDER
    UNION ALL SELECT 'MEDICATION_ORDER', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.MEDICATION_ORDER

    -- DIAGNOSTIC_ORDER (OLIDS_COMMON)
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER
    UNION ALL SELECT 'DIAGNOSTIC_ORDER', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.DIAGNOSTIC_ORDER

    -- ALLERGY_INTOLERANCE (OLIDS_COMMON)
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE
    UNION ALL SELECT 'ALLERGY_INTOLERANCE', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.ALLERGY_INTOLERANCE

    -- PROCEDURE_REQUEST (OLIDS_COMMON)
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.PROCEDURE_REQUEST
    UNION ALL SELECT 'PROCEDURE_REQUEST', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.PROCEDURE_REQUEST

    -- REFERRAL_REQUEST (OLIDS_COMMON)
    UNION ALL SELECT 'REFERRAL_REQUEST', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.REFERRAL_REQUEST
    UNION ALL SELECT 'REFERRAL_REQUEST', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.REFERRAL_REQUEST

    -- APPOINTMENT (OLIDS_COMMON)
    UNION ALL SELECT 'APPOINTMENT', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.APPOINTMENT
    UNION ALL SELECT 'APPOINTMENT', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.APPOINTMENT
    UNION ALL SELECT 'APPOINTMENT', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.APPOINTMENT
    UNION ALL SELECT 'APPOINTMENT', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.APPOINTMENT

    -- APPOINTMENT_PRACTITIONER (OLIDS_COMMON)
    UNION ALL SELECT 'APPOINTMENT_PRACTITIONER', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.APPOINTMENT_PRACTITIONER
    UNION ALL SELECT 'APPOINTMENT_PRACTITIONER', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.APPOINTMENT_PRACTITIONER
    UNION ALL SELECT 'APPOINTMENT_PRACTITIONER', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.APPOINTMENT_PRACTITIONER
    UNION ALL SELECT 'APPOINTMENT_PRACTITIONER', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.APPOINTMENT_PRACTITIONER

    -- PATIENT_REGISTERED_PRACTITIONER_IN_ROLE (OLIDS_COMMON)
    UNION ALL SELECT 'PATIENT_REGISTERED_PRACTITIONER_IN_ROLE', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.PATIENT_REGISTERED_PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PATIENT_REGISTERED_PRACTITIONER_IN_ROLE', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.PATIENT_REGISTERED_PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PATIENT_REGISTERED_PRACTITIONER_IN_ROLE', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.PATIENT_REGISTERED_PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PATIENT_REGISTERED_PRACTITIONER_IN_ROLE', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.PATIENT_REGISTERED_PRACTITIONER_IN_ROLE

    -- LOCATION (OLIDS_COMMON)
    UNION ALL SELECT 'LOCATION', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.LOCATION
    UNION ALL SELECT 'LOCATION', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.LOCATION
    UNION ALL SELECT 'LOCATION', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.LOCATION
    UNION ALL SELECT 'LOCATION', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.LOCATION

    -- LOCATION_CONTACT (OLIDS_COMMON)
    UNION ALL SELECT 'LOCATION_CONTACT', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.LOCATION_CONTACT
    UNION ALL SELECT 'LOCATION_CONTACT', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.LOCATION_CONTACT
    UNION ALL SELECT 'LOCATION_CONTACT', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.LOCATION_CONTACT
    UNION ALL SELECT 'LOCATION_CONTACT', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.LOCATION_CONTACT

    -- FLAG (OLIDS_COMMON)
    UNION ALL SELECT 'FLAG', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.FLAG
    UNION ALL SELECT 'FLAG', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.FLAG
    UNION ALL SELECT 'FLAG', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.FLAG
    UNION ALL SELECT 'FLAG', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.FLAG

    -- ORGANISATION (OLIDS_COMMON)
    UNION ALL SELECT 'ORGANISATION', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.ORGANISATION
    UNION ALL SELECT 'ORGANISATION', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.ORGANISATION
    UNION ALL SELECT 'ORGANISATION', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.ORGANISATION
    UNION ALL SELECT 'ORGANISATION', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.ORGANISATION

    -- PRACTITIONER (OLIDS_COMMON)
    UNION ALL SELECT 'PRACTITIONER', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.PRACTITIONER
    UNION ALL SELECT 'PRACTITIONER', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.PRACTITIONER
    UNION ALL SELECT 'PRACTITIONER', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.PRACTITIONER
    UNION ALL SELECT 'PRACTITIONER', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.PRACTITIONER

    -- PRACTITIONER_IN_ROLE (OLIDS_COMMON)
    UNION ALL SELECT 'PRACTITIONER_IN_ROLE', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PRACTITIONER_IN_ROLE', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PRACTITIONER_IN_ROLE', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.PRACTITIONER_IN_ROLE
    UNION ALL SELECT 'PRACTITIONER_IN_ROLE', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.PRACTITIONER_IN_ROLE

    -- SCHEDULE (OLIDS_COMMON)
    UNION ALL SELECT 'SCHEDULE', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.SCHEDULE
    UNION ALL SELECT 'SCHEDULE', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.SCHEDULE
    UNION ALL SELECT 'SCHEDULE', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.SCHEDULE
    UNION ALL SELECT 'SCHEDULE', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.SCHEDULE

    -- SCHEDULE_PRACTITIONER (OLIDS_COMMON)
    UNION ALL SELECT 'SCHEDULE_PRACTITIONER', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_COMMON.SCHEDULE_PRACTITIONER
    UNION ALL SELECT 'SCHEDULE_PRACTITIONER', 'lds_record_id', COUNT(*), COUNT(DISTINCT lds_record_id) FROM OLIDS_COMMON.SCHEDULE_PRACTITIONER
    UNION ALL SELECT 'SCHEDULE_PRACTITIONER', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_COMMON.SCHEDULE_PRACTITIONER
    UNION ALL SELECT 'SCHEDULE_PRACTITIONER', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_COMMON.SCHEDULE_PRACTITIONER

    -- CONCEPT (OLIDS_TERMINOLOGY) — no lds_record_id in this table
    UNION ALL SELECT 'CONCEPT', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_TERMINOLOGY.CONCEPT
    UNION ALL SELECT 'CONCEPT', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_TERMINOLOGY.CONCEPT
    UNION ALL SELECT 'CONCEPT', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_TERMINOLOGY.CONCEPT

    -- CONCEPT_MAP (OLIDS_TERMINOLOGY) — no lds_record_id in this table
    UNION ALL SELECT 'CONCEPT_MAP', 'id', COUNT(*), COUNT(DISTINCT id) FROM OLIDS_TERMINOLOGY.CONCEPT_MAP
    UNION ALL SELECT 'CONCEPT_MAP', 'lds_id', COUNT(*), COUNT(DISTINCT lds_id) FROM OLIDS_TERMINOLOGY.CONCEPT_MAP
    UNION ALL SELECT 'CONCEPT_MAP', 'lds_business_key', COUNT(*), COUNT(DISTINCT lds_business_key) FROM OLIDS_TERMINOLOGY.CONCEPT_MAP
)

-- Compute uniqueness % and compare against threshold
SELECT
    'uniqueness' AS test_name,
    table_name,
    CASE WHEN total_rows = 0 THEN column_name || ' (empty table)' ELSE column_name END AS test_subject,
    CASE
        WHEN total_rows = 0 THEN 'WARN'
        WHEN distinct_count = total_rows THEN 'PASS'
        ELSE 'FAIL'
    END AS status,
    CASE WHEN total_rows = 0 THEN NULL ELSE TRUNC(100.0 * distinct_count / total_rows, 4) END AS metric_value,
    100.0 AS threshold,
    total_rows,
    distinct_count,
    total_rows - distinct_count AS duplicate_count
FROM checks
ORDER BY status DESC, metric_value ASC, table_name, column_name;
